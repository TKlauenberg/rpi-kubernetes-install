---
- name: Set hostname
  ansible.builtin.hostname:
    name: '{{ inventory_hostname }}'

- name: "Build hosts file"
  lineinfile:
    dest: /etc/hosts
    regexp: '.*{{ item }}$'
    line: "{{ hostvars[item]['ansible_default_ipv4']['address'] }} {{ item }} {{ item }}.fritz.box"
    state: present
  register: etchostsupdate
  when: hostvars[item]['ansible_facts']['default_ipv4'] is defined
  with_items:
    - "{{ groups['all'] }}"

- name: Enable promisc mode for ARP requests
  ansible.builtin.command: "ip link set {{ ansible_default_ipv4.alias }} promisc on"
  when: "not ansible_facts[ansible_facts['default_ipv4']['alias']]['promisc']"
